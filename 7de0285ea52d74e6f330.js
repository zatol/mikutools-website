(window.webpackJsonp=window.webpackJsonp||[]).push([[138],{2785:function(t,e,n){"use strict";n.r(e);n(134),n(425),n(31),n(23),n(105),n(1047),n(103),n(133),n(40);var r=n(9),o=n(2483),c=n.n(o),l=n(189),d=n.n(l),h={name:"StarHistory",components:{VeLine:c.a},head:function(){return this.$store.state.currentTool.head},data:function(){return{repo:"",token:"",loading:!1,sampleNum:15,chartData:{columns:["date","starNum"],rows:[]},chartExtend:{legend:{show:!1}},chartSettings:{legend:{show:!1},xAxisType:"time"}}},methods:{query:function(){var t=this;return Object(r.a)(regeneratorRuntime.mark((function e(){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.loading=!0,t.chartData.rows=[],t.repo.includes("github.com")?(t.repo+="/",t.repo=/github\.com\/(\S*?\/\S*?)[/#?]/.exec(t.repo)[1]):t.repo=""==t.repo?"Ice-Hazymoon/MikuTools":t.repo,!(n=t.$db.get('tool.star_history["'.concat(t.repo,'"]')).value())){e.next=9;break}t.loading=!1,t.chartData.rows=n,e.next=22;break;case 9:return e.prev=9,e.next=12,t.getStarHistory(t.repo,t.token?t.token:void 0);case 12:r=e.sent,t.loading=!1,t.chartData.rows=r,t.$db.set('tool.star_history["'.concat(t.repo,'"]'),r).write(),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(9),t.loading=!1,e.t0.message.indexOf("403")>=0?t.$notify.error({title:"统计失败",message:"请求次数过多，请填写 Token 以获取更多配额"}):t.$notify.error({title:"统计失败",message:e.t0});case 22:case"end":return e.stop()}}),e,null,[[9,18]])})))()},range:function(t){return Array.apply(null,{length:t}).map((function(t,i){return i+1}))},generateUrls:function(t,e){var n=this;return Object(r.a)(regeneratorRuntime.mark((function r(){var o,c,l,link,h,m,f;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=d.a.create({headers:{Accept:"application/vnd.github.v3.star+json"},params:{access_token:e}}),c="https://api.github.com/repos/".concat(t,"/stargazers"),r.next=4,o.get(c,{auth:!1,headers:{Accept:"application/vnd.github.v3.star+json"},params:{access_token:e}});case 4:return l=r.sent,link=l.headers.link,h=link?/next.*?page=(\d*).*?last/.exec(link)[1]:1,m=h<=n.sampleNum?n.range(h).slice(1,h):n.range(n.sampleNum).map((function(t){return Math.round(t/n.sampleNum*h)-1})),f=m.map((function(t){return"".concat(c,"?page=").concat(t)})),r.abrupt("return",{firstPage:l,sampleUrls:f,pageIndexes:m});case 10:case"end":return r.stop()}}),r)})))()},getStarHistory:function(t,e){var n=this;return Object(r.a)(regeneratorRuntime.mark((function r(){var o,c,l,h,m,f,v,k,w,y,x,_,D,A,S,j,M;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=d.a.create({headers:{Accept:"application/vnd.github.v3.star+json"},params:{access_token:e}}),r.next=3,n.generateUrls(t,e);case 3:return c=r.sent,l=c.sampleUrls,h=c.pageIndexes,m=c.firstPage,f=[m].concat(l.map((function(t){return o.get(t,{auth:!1,headers:{Accept:"application/vnd.github.v3.star+json"},params:{access_token:e}})}))),r.next=10,Promise.all(f);case 10:return v=r.sent,k=null,h[h.length-1]>n.sampleNum?k=h.map((function(p,i){return{date:v[i+1].data[0].starred_at.slice(0,10),starNum:30*(p-1)}})):(w=v.reduce((function(t,e){return t.concat(e.data)}),[]),y=new Date(w[0].starred_at),x=Math.round(new Date-y)/864e5,_=Array.from(new Array(50)).map((function(t,i){var e=new Date(y);return e.setDate(e.getDate()+Math.floor(x/50*(i+1))),e.toISOString().slice(0,10)}),[]),k=_.map((function(t){var e=0,n=w.find((function(n,i){return n.starred_at.slice(0,10)>=t&&(e=i+1,!0)}));return n&&{date:n.starred_at.slice(0,10),starNum:e}})).filter((function(t){return t}))),r.next=15,o.get("https://api.github.com/repos/".concat(t),{auth:!1,headers:{Accept:"application/vnd.github.v3.star+json"},params:{access_token:e}});case 15:return D=r.sent,A=D.data.stargazers_count,S=new Date,j=S.getMonth()+1>10?S.getMonth()+1:"0".concat(S.getMonth()+1),M=S.getDate()>10?S.getDate():"0".concat(S.getDate()),k.push({date:"".concat(S.getFullYear(),"-").concat(j,"-").concat(M),starNum:A}),r.abrupt("return",k);case 22:case"end":return r.stop()}}),r)})))()}}},m=n(5),component=Object(m.a)(h,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"star_history"},[n("nya-container",{attrs:{title:"Star 历史查询"}},[n("div",{staticClass:"nya-subtitle"},[t._v("\n            请输入GitHub项目地址\n        ")]),n("el-input",{staticClass:"mb-15",attrs:{autofocus:"",disabled:t.loading,placeholder:"https://github.com/Ice-Hazymoon/MikuTools"},model:{value:t.repo,callback:function(e){t.repo="string"==typeof e?e.trim():e},expression:"repo"}}),n("div",{staticClass:"nya-subtitle"},[t._v("\n            Access Token\n        ")]),n("el-input",{staticClass:"mb-15",attrs:{autofocus:"",disabled:t.loading,placeholder:"私有仓库或访问超过限制则必填"},model:{value:t.token,callback:function(e){t.token="string"==typeof e?e.trim():e},expression:"token"}}),n("el-button",{attrs:{type:"primary",loading:t.loading},on:{click:t.query}},[t._v("\n            "+t._s(t.loading?"统计中":"开始统计")+"\n        ")])],1),t.chartData.rows.length?n("nya-container",{attrs:{title:"查询结果"}},[n("ve-line",{attrs:{data:t.chartData,settings:t.chartSettings,extend:t.chartExtend}})],1):t._e(),n("nya-container",{attrs:{title:"说明"}},[n("ul",{staticClass:"nya-list"},[n("li",[t._v("Access Token 申请地址："),n("a",{attrs:{href:"https://github.com/settings/tokens/new?scopes=repo",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/settings/tokens/new?scopes=repo")])]),n("li",[t._v("所有过程都不会经过 MikuTools 的服务器，本站不会记录你的 Access Token，可放心使用")])])])],1)}),[],!1,null,null,null);e.default=component.exports}}]);